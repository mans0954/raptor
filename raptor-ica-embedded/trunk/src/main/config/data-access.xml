<?xml version="1.0" encoding="UTF-8"?>
	<!--

		Copyright (C) 2010 Cardiff University, Wales <smartp@cf.ac.uk>

		Licensed under the Apache License, Version 2.0 (the "License"); you
		may not use this file except in compliance with the License. You may
		obtain a copy of the License at

		http://www.apache.org/licenses/LICENSE-2.0 Unless required by
		applicable law or agreed to in writing, software distributed under the
		License is distributed on an "AS IS" BASIS, WITHOUT WARRANTIES OR
		CONDITIONS OF ANY KIND, either express or implied. See the License for
		the specific language governing permissions and limitations under the
		License.
	-->

<beans xmlns="http://www.springframework.org/schema/beans"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="
	http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd">

	<!--  List all the data access beans, used by the parser -->
	<bean id="dataAccessRegister" class="uk.ac.cardiff.raptor.raptorica.engine.DataAccessRegister">
		<property name="authenticationModules">
			<list><!--
				<bean id="shibbolethAccessLFP" class="uk.ac.cardiff.raptor.raptorica.dao.external.file.LogFileParser">
					<property name="entryHandler"><ref bean="memoryEntryHandler"></ref></property>
					<property name="logfile">
						<value>file:///Users/philsmart/Documents/DataSets/Logs/idp-access-2010-10-24.idp1.log
						</value>
					</property>
					<property name="format">
						<ref bean="shibIDPAccessFileFormat" />
					</property>
					<property name="entryType">
						<value>uk.ac.cardiff.model.ShibbolethEntry</value>
					</property>
				</bean>

				--><!--
					this entry parses the audit log, but only for AuthnRequest rows. If persist is true, you need to supply
					a valid dataConnection. Persist in this context is only the persistance of enough state information that
					it can pick up where it left off in the even of a failure
				-->
				<bean id="shibbolethAuditLFP" class="uk.ac.cardiff.raptor.raptorica.dao.external.file.LogFileParser">
					<property name="entryHandler"><ref bean="memoryEntryHandler"></ref></property>
					<property name="logfile">
						<value>file:///Users/philsmart/Documents/DataSets/Logs/shib2comb-sorted-year.log
						</value>
					</property>
					<property name="format">
						<ref bean="shibIDPAuditFileFormat" />
					</property>
					<property name="entryType">
						<value>uk.ac.cardiff.model.ShibbolethEntry</value>
					</property>

					<!--  The inclusion list is an OR of field name, value pairs that are loaded by the parser
					 all other fields are ignored, this is run before the exclusion list-->
					<property name="inclusionList">
							<bean class="uk.ac.cardiff.raptor.raptorica.model.InclusionList">
								<property name="inclusionEntries">
									<list>
										<bean class ="uk.ac.cardiff.raptor.raptorica.model.RegexInclusionEntry">
											<property name ="fieldName" value="messageProfileId"/>
											<property name="match" value=":sso"/>
										</bean>
									</list>
								</property>
							</bean>
					</property>

					<!--
						exclude entries, is an OR list of <field name, field value> pairs
						that are checked for when parsing , if oneof them exists, that entry is
						ignored.
					-->
					<!--<property name="exclusionList">
							<bean class="uk.ac.cardiff.raptor.raptorica.model.ExclusionList">
								<property name="exclusionEntries">
									<list>
										<bean class ="uk.ac.cardiff.raptor.raptorica.model.ExactMatchExclusionEntry">
											<property name ="fieldName" value="requestBinding"/>
											<property name="match" value="urn:oasis:names:tc:SAML:2.0:bindings:HTTP-POST"/>
										</bean>
										<bean class ="uk.ac.cardiff.raptor.raptorica.model.ExactMatchExclusionEntry">
											<property name ="fieldName" value="requestBinding"/>
											<property name="match" value="urn:oasis:names:tc:SAML:1.0:bindings:SOAP-binding"/>
										</bean>
										<bean class ="uk.ac.cardiff.raptor.raptorica.model.ExactMatchExclusionEntry">
											<property name ="fieldName" value="requestBinding"/>
											<property name="match" value="urn:oasis:names:tc:SAML:2.0:bindings:HTTP-Redirect"/>
										</bean>
									</list>
								</property>
							</bean>
					</property>
				--></bean>
			</list>
		</property>
	</bean>

	<!-- Create the entry handler -->
	<bean name="memoryEntryHandler" class="uk.ac.cardiff.raptor.raptorica.model.MemoryEntryHandler"></bean>
	<bean name="persistantEntryHandler" class="uk.ac.cardiff.raptor.raptorica.model.PersistantEntryHandler">
		<constructor-arg index="0"><ref bean="dataConnectionImpl"></ref></constructor-arg>
	</bean>

	<!--
		definition of the log file format, where some standard log file
		formats will be specified here e.g. shib-access, W3C, apache, EZProxy
		etc IMPORTANT, the headers must be a match for the internal model at
		the moment
	-->

	<!-- accepted types are DATE, STRING, INTEGER -->

	<bean id="shibIDPAccessFileFormat" class="uk.ac.cardiff.raptor.raptorica.dao.external.format.LogFileFormat">
		<property name="headers">
			<list>
				<bean class="uk.ac.cardiff.raptor.raptorica.dao.external.format.Header">
					<property name="fieldName">
						<value>eventTime</value>
					</property>
					<property name="fieldNo">
						<value>0</value>
					</property>
					<property name="fieldType">
						<value>DATE</value>
					</property>
					<property name="dateTimeFormat">
						<value>yyyyMMdd'T'HHmmss</value>
					</property> <!--  Atom (ISO 8601) -->
				</bean>
				<bean class="uk.ac.cardiff.raptor.raptorica.dao.external.format.Header">
					<property name="fieldName">
						<value>requestHost</value>
					</property>
					<property name="fieldNo">
						<value>1</value>
					</property>
					<property name="fieldType">
						<value>STRING</value>
					</property>
				</bean>
				<bean class="uk.ac.cardiff.raptor.raptorica.dao.external.format.Header">
					<property name="fieldName">
						<value>requestID</value>
					</property>
					<property name="fieldNo">
						<value>2</value>
					</property>
					<property name="fieldType">
						<value>STRING</value>
					</property>
				</bean>
				<bean class="uk.ac.cardiff.raptor.raptorica.dao.external.format.Header">
					<property name="fieldName">
						<value>requestPath</value>
					</property>
					<property name="fieldNo">
						<value>3</value>
					</property>
					<property name="fieldType">
						<value>STRING</value>
					</property>
				</bean>
			</list>
		</property>
		<property name="delimeter">
			<value>|</value>
		</property>
	</bean>

	<bean id="shibIDPAuditFileFormat" class="uk.ac.cardiff.raptor.raptorica.dao.external.format.LogFileFormat">
		<property name="headers">
			<list>
				<bean class="uk.ac.cardiff.raptor.raptorica.dao.external.format.Header">
					<property name="fieldName">
						<value>eventTime</value>
					</property>
					<property name="fieldNo">
						<value>0</value>
					</property>
					<property name="fieldType">
						<value>DATE</value>
					</property>
					<property name="dateTimeFormat">
						<value>yyyyMMdd'T'HHmmss</value>
					</property> <!--  Atom (ISO 8601) -->
				</bean>
				<bean class="uk.ac.cardiff.raptor.raptorica.dao.external.format.Header">
					<property name="fieldName">
						<value>requestBinding</value>
					</property>
					<property name="fieldNo">
						<value>1</value>
					</property>
					<property name="fieldType">
						<value>STRING</value>
					</property>
				</bean>
				<bean class="uk.ac.cardiff.raptor.raptorica.dao.external.format.Header">
					<property name="fieldName">
						<value>requestId</value>
					</property>
					<property name="fieldNo">
						<value>2</value>
					</property>
					<property name="fieldType">
						<value>STRING</value>
					</property>
				</bean>
				<bean class="uk.ac.cardiff.raptor.raptorica.dao.external.format.Header">
					<property name="fieldName">
						<value>requestHost</value>
					</property>
					<property name="fieldNo">
						<value>3</value>
					</property>
					<property name="fieldType">
						<value>STRING</value>
					</property>
				</bean>

				<bean class="uk.ac.cardiff.raptor.raptorica.dao.external.format.Header">
					<property name="fieldName">
						<value>messageProfileId</value>
					</property>
					<property name="fieldNo">
						<value>4</value>
					</property>
					<property name="fieldType">
						<value>STRING</value>
					</property>
				</bean>
				<bean class="uk.ac.cardiff.raptor.raptorica.dao.external.format.Header">
					<property name="fieldName">
						<value>responseBinding</value>
					</property>
					<property name="fieldNo">
						<value>6</value>
					</property>
					<property name="fieldType">
						<value>STRING</value>
					</property>
				</bean>
				<bean class="uk.ac.cardiff.raptor.raptorica.dao.external.format.Header">
					<property name="fieldName">
						<value>responseId</value>
					</property>
					<property name="fieldNo">
						<value>7</value>
					</property>
					<property name="fieldType">
						<value>STRING</value>
					</property>
				</bean>
				<bean class="uk.ac.cardiff.raptor.raptorica.dao.external.format.Header">
					<property name="fieldName">
						<value>principleName</value>
					</property>
					<property name="fieldNo">
						<value>8</value>
					</property>
					<property name="fieldType">
						<value>STRING</value>
					</property>
				</bean>
				<bean class="uk.ac.cardiff.raptor.raptorica.dao.external.format.Header">
					<property name="fieldName">
						<value>authNMethod</value>
					</property>
					<property name="fieldNo">
						<value>9</value>
					</property>
					<property name="fieldType">
						<value>STRING</value>
					</property>
				</bean>
				<bean class="uk.ac.cardiff.raptor.raptorica.dao.external.format.Header">
					<property name="fieldName">
						<value>releasedAttributes</value>
					</property>
					<property name="fieldNo">
						<value>10</value>
					</property>
					<property name="fieldType">
						<value>STRINGLIST</value>
					</property>
					<property name="listDelimeter">
						<value>,</value>
					</property>
				</bean>
				<bean class="uk.ac.cardiff.raptor.raptorica.dao.external.format.Header">
					<property name="fieldName">
						<value>nameIdentifier</value>
					</property>
					<property name="fieldNo">
						<value>9</value>
					</property>
					<property name="fieldType">
						<value>STRING</value>
					</property>
				</bean>
				<bean class="uk.ac.cardiff.raptor.raptorica.dao.external.format.Header">
					<property name="fieldName">
						<value>assertionId</value>
					</property>
					<property name="fieldNo">
						<value>12</value>
					</property>
					<property name="fieldType">
						<value>STRINGLIST</value>
					</property>
					<property name="listDelimeter">
						<value>,</value>
					</property>
				</bean>
			</list>
		</property>
		<property name="delimeter">
			<value>|</value>
		</property>
	</bean>

	<bean id="EZProxyFileFormat" class="uk.ac.cardiff.raptor.raptorica.dao.external.format.LogFileFormat"></bean>

	<bean id="W3CFileFormat" class="uk.ac.cardiff.raptor.raptorica.dao.external.format.LogFileFormat"></bean>




</beans>
